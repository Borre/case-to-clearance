version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: case-to-clearance
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Huawei Cloud MaaS Configuration
      - MAAS_API_KEY=${MAAS_API_KEY:-}
      - MAAS_REGION=${MAAS_REGION:-ap-southeast-1}
      - MAAS_ENDPOINT=${MAAS_ENDPOINT:-https://api-ap-southeast-1.modelarts-maas.com/v2/chat/completions}
      - MAAS_MODEL_REASONER=${MAAS_MODEL_REASONER:-deepseek-v3.1}
      - MAAS_MODEL_WRITER=${MAAS_MODEL_WRITER:-qwen3-32b}

      # Huawei Cloud OCR Configuration
      - OCR_ENDPOINT=${OCR_ENDPOINT:-https://ocr.ap-southeast-1.myhuaweicloud.com}
      - OCR_REGION=${OCR_REGION:-ap-southeast-1}
      - OCR_AK=${OCR_AK:-}
      - OCR_SK=${OCR_SK:-}
      - OCR_PROJECT_ID=${OCR_PROJECT_ID:-}

      # Application Settings
      - APP_ENV=${APP_ENV:-production}
      - APP_LOG_LEVEL=${APP_LOG_LEVEL:-INFO}
      - APP_MAX_UPLOAD_SIZE_MB=${APP_MAX_UPLOAD_SIZE_MB:-20}
      - APP_ALLOWED_EXTENSIONS=${APP_ALLOWED_EXTENSIONS:-.pdf,.png,.jpg,.jpeg,.tiff,.bmp}

      # Rate Limiting
      - MAX_REQUESTS_PER_MINUTE=${MAX_REQUESTS_PER_MINUTE:-60}

      # Security
      - ENABLE_REDACTION=${ENABLE_REDACTION:-true}
    volumes:
      # Persist case data
      - ./production/runs:/app/production/runs
      - ./production/logs:/app/production/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - case-to-clearance-network

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: case-to-clearance-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - case-to-clearance-network
    profiles:
      - with-nginx

networks:
  case-to-clearance-network:
    driver: bridge

volumes:
  case-data:
    driver: local

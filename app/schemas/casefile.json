{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CaseFile",
  "description": "The core state object for a customs clearance case",
  "type": "object",
  "required": ["case_id", "created_at", "updated_at"],
  "properties": {
    "case_id": {
      "type": "string",
      "pattern": "^case-[a-f0-9]{12}$",
      "description": "Unique case identifier"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp of case creation"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp of last update"
    },
    "procedure": {
      "type": "object",
      "description": "Selected procedure from classification",
      "properties": {
        "id": {"type": "string"},
        "name": {"type": "string"},
        "confidence": {"type": "number", "minimum": 0, "maximum": 1},
        "rationale": {"type": "string"}
      }
    },
    "citizen_intake": {
      "type": "object",
      "description": "Chat intake state",
      "properties": {
        "messages": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "role": {"type": "string", "enum": ["user", "assistant", "system"]},
              "content": {"type": "string"},
              "timestamp": {"type": "string", "format": "date-time"}
            },
            "required": ["role", "content", "timestamp"]
          }
        },
        "collected_fields": {"type": "object"},
        "missing_fields": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "documents": {
      "type": "object",
      "properties": {
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "doc_id": {"type": "string"},
              "filename": {"type": "string"},
              "mime": {"type": "string"},
              "size": {"type": "integer"},
              "uploaded_at": {"type": "string", "format": "date-time"}
            },
            "required": ["doc_id", "filename", "mime", "size", "uploaded_at"]
          }
        },
        "ocr": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "doc_id": {"type": "string"},
              "text": {"type": "string"},
              "meta": {"type": "object"},
              "processed_at": {"type": "string", "format": "date-time"}
            },
            "required": ["doc_id", "text", "processed_at"]
          }
        },
        "extractions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "doc_id": {"type": "string"},
              "doc_type": {
                "type": "string",
                "enum": ["invoice", "bl", "packing_list", "declaration", "permit", "other"]
              },
              "fields": {"type": "object"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1},
              "low_confidence_fields": {
                "type": "array",
                "items": {"type": "string"}
              },
              "extraction_timestamp": {"type": "string", "format": "date-time"}
            },
            "required": ["doc_id", "doc_type", "fields", "confidence"]
          }
        },
        "validations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "rule_id": {"type": "string"},
              "severity": {
                "type": "string",
                "enum": ["info", "warn", "high", "critical"]
              },
              "message": {"type": "string"},
              "evidence": {"type": "object"}
            },
            "required": ["rule_id", "severity", "message"]
          }
        },
        "missing_docs": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "risk": {
      "type": "object",
      "properties": {
        "score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "level": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]
        },
        "factors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "factor_id": {"type": "string"},
              "description": {"type": "string"},
              "input_value": {},
              "points_added": {"type": "integer"}
            },
            "required": ["factor_id", "description", "points_added"]
          }
        },
        "explanation": {
          "type": "object",
          "properties": {
            "executive_summary": {"type": "string"},
            "explanation_bullets": {
              "type": "array",
              "items": {"type": "string"}
            },
            "recommended_next_actions": {
              "type": "array",
              "items": {"type": "string"}
            },
            "risk_reduction_actions": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "confidence": {
          "type": "string",
          "enum": ["HIGH", "MEDIUM", "LOW"]
        },
        "review_required": {"type": "boolean"}
      }
    },
    "audit": {
      "type": "object",
      "properties": {
        "trace_id": {"type": "string"},
        "trace": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "stage": {"type": "string"},
              "model_used": {"type": "string"},
              "inputs_redacted": {"type": "string"},
              "outputs_summary": {"type": "string"}
            },
            "required": ["timestamp", "stage", "model_used", "inputs_redacted", "outputs_summary"]
          }
        },
        "disclaimers": {
          "type": "array",
          "items": {"type": "string"}
        },
        "redactions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "what": {"type": "string"},
              "why": {"type": "string"}
            }
          }
        },
        "rule_version": {"type": "string"},
        "performance_metrics": {
          "type": "object",
          "properties": {
            "ocr_duration_ms": {"type": "number"},
            "llm_total_duration_ms": {"type": "number"},
            "validation_duration_ms": {"type": "number"}
          }
        }
      }
    }
  }
}
